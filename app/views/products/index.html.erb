<div id="filters">
<%@categories.each do |category|%>
	<input type="checkbox" value="<%=category.id%>" id="<%=category.id%>" name ="<%=category.name%> "onchange="myFunction(<%=category.id%>)"/> <%=category.name %>
<%end%>
</div>
<%=form_tag(products_path,method: 'get') do %>
	<%=text_field_tag :search%>
	<%=submit_tag "search"%>
<%end%>
<div id="slidecontainer" align="right">
 Sort: <input type="range" min="1" max="100" value="" class="slider" id="myRange">
 min:<input type="number" id="min" >
 max:<input type="number" id="max" >
</div>
<h2>Listing Products</h2>

<%#=form_tag(products_path,method: 'get') do%>
	<%#@categories.each do |category|%>
		<%#=check_box_tag 'cat_ids[]', category.id%>
		<%#=category.name%>
	<%#end%>
<%#=submit_tag 'filter'%>
<%#end%>
<% if @products.empty?  %>
	<p>No Products</p>
<% else  %>
	<table border="1" id="myTable">
		<thead>
			<tr>
				<th>Name</th>
				<th>Price</th>
				<th>category</th>
				
			</tr>
		</thead>
		<tbody id="myBody">
				<% @products.each do |product|  %>
			<tr>	
				<td><%= link_to product.name,product_path(product.id)  %></td>
				<td><%= product.price  %></td>
				<td><%=link_to product.category.name,category_path(product.category_id)%></td>
			</tr>
				<%end%>
			</tbody>
	</table>
	
<% end %>
<%if user_signed_in? && current_user.is_admin%>
<%= link_to "AddProduct",new_product_path %>
<%end%>

<script>
	var values=[];
	var tableHandle = document.getElementById('myTable')
	var bodyHandle =document.getElementById('myBody')
	var silderHandle =document.getElementById('myRange')

	myRange.oninput = function(){
		
		var xhr = new XMLHttpRequest();
		xhr.open('GET','http://localhost:3000/products?sort='+this.value,true)
		console.log(this.value)
		xhr.onreadystatechange =function(){
			if (xhr.readyState === 4 && xhr.status === 200) {
				var products = JSON.parse(xhr.responseText);
				emptyBody();
				
				products.forEach(function(product){
				var row = tableHandle.insertRow(-1);
				var link = document.createElement("a");
				link.setAttribute('href','http://localhost:3000/products/'+product.id)
				//row.setAttribute('cat_name',"tr_"+product.category_id);
				
				var cell1 = row.insertCell(0);
				var cell2 = row.insertCell(1);
				var cell3 = row.insertCell(2);
				cell1.setAttribute('href','http://localhost:3000/products/'+product.id)
				console.log(cell1)
				

				cell1.innerHTML = product.name
				cell2.innerHTML = product.price
				cell3.innerHTML = product.category_name
				
				bodyHandle.appendChild(row)	
				});
			}
		}
		xhr.send();
	};


	function myFunction(ids) {
			
		if (document.getElementById(ids).checked) {
			if (!values.includes(ids)) 
			{
				values.push(ids);
				getProducts(values);
			}else{
				values.splice(values.indexOf(ids),1);
				getProducts(values);
				
			}
		}else{
			values.splice(values.indexOf(ids),1);
			getProducts(values);
		}
	}
	
	//to empty the body of the table
	function emptyBody(){
		bodyHandle.innerHTML = "";
	}

	function getProducts(values){
		var xhr = new XMLHttpRequest();
		xhr.open('GET','http://localhost:3000/products?ids='+values,true)
		xhr.onreadystatechange =function(){
			if (xhr.readyState === 4 && xhr.status === 200) {
				var products = JSON.parse(xhr.responseText);
				emptyBody();
				
				products.forEach(function(product){
				var row = tableHandle.insertRow(-1);
				var link = document.createElement("a");
				link.setAttribute('href','http://localhost:3000/products/'+product.id)
				//row.setAttribute('cat_name',"tr_"+product.category_id);
				
				var cell1 = row.insertCell(0);
				var cell2 = row.insertCell(1);
				var cell3 = row.insertCell(2);
				cell1.setAttribute('href','http://localhost:3000/products/'+product.id)
				console.log(cell1)
				

				cell1.innerHTML = product.name
				cell2.innerHTML = product.price
				cell3.innerHTML = product.category_name
				
				bodyHandle.appendChild(row)	
				});
			}
		}
		xhr.send();
	}
	
</script>